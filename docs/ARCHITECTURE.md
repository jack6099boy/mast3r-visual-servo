# 多邊形目標點轉換工具 - 架構流程圖

## 系統概覽

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Polygon Target Transfer Tool                          │
│                     (polygon_target_transfer.py)                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 完整流程圖

```
┌──────────────────┐     ┌──────────────────┐
│   Template 影像   │     │   Target 影像     │
│   (參考/模板)     │     │   (目標/當前)     │
└────────┬─────────┘     └────────┬─────────┘
         │                         │
         │  ┌─────────────────┐   │
         │  │  多邊形 ROI      │   │
         │  │  [[x1,y1],...]  │   │
         │  └────────┬────────┘   │
         │           │             │
         │  ┌────────┴────────┐   │
         │  │  自定義目標點    │   │
         │  │  [x, y]         │   │
         │  └────────┬────────┘   │
         │           │             │
         ▼           │             ▼
┌────────────────────┴─────────────────────┐
│              Step 1: MASt3R 特徵匹配      │
│  ┌─────────────────────────────────────┐ │
│  │  load_images() → inference()        │ │
│  │  → fast_reciprocal_NNs()            │ │
│  └─────────────────────────────────────┘ │
│                                          │
│  輸出: matches_template[], matches_target[] │
│        (651 對匹配點)                     │
└────────────────────┬─────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────┐
│         Step 2: 多邊形內過濾              │
│  ┌─────────────────────────────────────┐ │
│  │  for each match:                    │ │
│  │    if point_in_polygon(match):      │ │
│  │      keep it                        │ │
│  └─────────────────────────────────────┘ │
│                                          │
│  輸出: 55 個多邊形內的匹配點              │
└────────────────────┬─────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────┐
│         Step 3: RANSAC 過濾 Outliers     │
│  ┌─────────────────────────────────────┐ │
│  │  repeat many times:                 │ │
│  │    1. random select points          │ │
│  │    2. fit transform model           │ │
│  │    3. count inliers                 │ │
│  │    4. keep best model               │ │
│  └─────────────────────────────────────┘ │
│                                          │
│  輸出: 25 個 inliers (正確匹配)           │
│        + 變換矩陣 M                      │
└────────────────────┬─────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────┐
│         Step 4: 計算變換矩陣              │
│  ┌─────────────────────────────────────┐ │
│  │  方法選擇:                          │ │
│  │  ┌─────────┬─────────┬───────────┐ │ │
│  │  │ partial │ affine  │homography │ │ │
│  │  │  4 DOF  │  6 DOF  │  8 DOF    │ │ │
│  │  └─────────┴─────────┴───────────┘ │ │
│  └─────────────────────────────────────┘ │
│                                          │
│  輸出: Transform Matrix M (2x3 or 3x3)   │
│        ┌         ┐                       │
│        │ a  b tx │                       │
│        │ c  d ty │                       │
│        └         ┘                       │
└────────────────────┬─────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────┐
│         Step 5: 轉換目標點               │
│  ┌─────────────────────────────────────┐ │
│  │  [x']       [a  b tx] [x]           │ │
│  │  [y']   =   [c  d ty] [y]           │ │
│  │                       [1]           │ │
│  │                                     │ │
│  │  (150, 200) → (100.52, 220.19)     │ │
│  └─────────────────────────────────────┘ │
│                                          │
│  輸出: 轉換後的目標點座標                 │
└────────────────────┬─────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────┐
│         Step 6: 視覺化輸出               │
│  ┌─────────────────────────────────────┐ │
│  │  ┌──────┐  ┌──────┐  ┌──────┐      │ │
│  │  │ ROI  │  │ 匹配線│  │ 結果 │      │ │
│  │  │  +   │  │      │  │  +   │      │ │
│  │  │ 原點 │  │      │  │ 新點 │      │ │
│  │  └──────┘  └──────┘  └──────┘      │ │
│  └─────────────────────────────────────┘ │
│                                          │
│  輸出: transfer_result.png               │
└──────────────────────────────────────────┘
```

## 資料流圖

```
輸入                           處理                          輸出
─────                         ────                          ────

Template.jpg  ──┐
                 ├─→  MASt3R  ──→  matches[]  ──┐
Target.jpg   ──┘                                │
                                                 ├─→  過濾  ──→  polygon_matches[]
Polygon[]    ───────────────────────────────────┘
                                                               │
                                                               ▼
                                                         RANSAC + 變換
                                                               │
                                                               ▼
Target_point ────────────────────────────────────→   Matrix × Point
                                                               │
                                                               ▼
                                                      Transformed_point
                                                               │
                                                               ▼
                                                      visualization.png
```

## 核心函數調用順序

```python
# 1. 初始化
transfer = PolygonTargetTransfer(device='mps')

# 2. 主函數調用
result = transfer.transfer_target_point(
    template_path,    # 輸入: Template 影像
    target_path,      # 輸入: Target 影像
    polygon,          # 輸入: 多邊形頂點
    target_point,     # 輸入: 目標點
    transform_method  # 輸入: 變換方法
)

# 內部調用順序:
# ├── load_model()                    # 載入 MASt3R
# ├── get_matches()                   # 特徵匹配
# │   ├── load_images()              
# │   ├── inference()                 # MASt3R 推理
# │   └── fast_reciprocal_NNs()       # 找匹配點
# ├── filter_matches_in_polygon()     # 過濾多邊形內
# ├── compute_transform()             # 計算變換 (含 RANSAC)
# ├── transform_point()               # 轉換目標點
# └── _visualize()                    # 視覺化
```

## 變換方法比較

```
              輸入座標                    輸出座標
              ────────                    ────────
              
partial      (150, 200)  ────→  M_4dof  ────→  (100.52, 220.19)
(4 DOF)      平移 + 旋轉 + 均勻縮放
              
affine       (150, 200)  ────→  M_6dof  ────→  (128.51, 209.02)
(6 DOF)      + 非均勻縮放 + 剪切
              
homography   (150, 200)  ────→  M_8dof  ────→  (130.08, 206.40)
(8 DOF)      透視變換 (相機斜看)
```

## Visual Servo 整合

```
┌─────────────────────────────────────────────────────────────┐
│                    閉環控制系統                              │
│                                                             │
│  ┌──────────┐    ┌──────────────┐    ┌──────────────┐      │
│  │  相機    │ →  │ 本工具       │ →  │ 計算誤差     │      │
│  │  拍攝    │    │ (目標點轉換) │    │ delta_pose   │      │
│  └──────────┘    └──────────────┘    └──────┬───────┘      │
│                                              │               │
│                                              ▼               │
│  ┌──────────┐    ┌──────────────┐    ┌──────────────┐      │
│  │  機械臂  │ ←  │ 控制器       │ ←  │ 誤差太大?    │      │
│  │  移動    │    │ (PID/gain)   │    │ 繼續調整     │      │
│  └──────────┘    └──────────────┘    └──────────────┘      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```
